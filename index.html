<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>PROBER</title>
        <link
            rel="icon"
            type="image/svg+xml"
            href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2360A5FA'><path d='M12 2L4 6v5c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V6l-8-4zm0 2.26L18 7.3v3.7c0 4.52-3.13 8.72-6 9.8-2.87-1.08-6-5.28-6-9.8V7.3l6-3.04z'/><path d='M12 7a2 2 0 0 0-2 2v2a2 2 0 0 0 1 1.72V15h2v-2.28A2 2 0 0 0 14 11V9a2 2 0 0 0-2-2z'/></svg>"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .table-fixed {
            table-layout: fixed;
            }

            td, th {
            white-space: normal; /* Allow text wrapping */
            word-wrap: break-word; /* Break long words */
            word-break: break-word; /* Ensure long unbreakable strings wrap */
            padding: 0.5rem; /* Add some padding */
            }
        </style>
    </head>
    <body class="bg-gradient-to-br from-gray-900 to-slate-900 min-h-screen">
        <!-- Header -->
        <header
            class="backdrop-blur-lg bg-slate-800/30 border-b border-slate-700/50"
        >
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <a
                            href="/"
                            class="flex items-center space-x-3 hover:no-underline"
                        >
                            <svg
                                class="w-8 h-8 text-blue-400"
                                viewBox="0 0 24 24"
                                fill="currentColor"
                            >
                                <path
                                    d="M12 2L4 6v5c0 5.55 3.84 10.74 8 12 4.16-1.26 8-6.45 8-12V6l-8-4zm0 2.26L18 7.3v3.7c0 4.52-3.13 8.72-6 9.8-2.87-1.08-6-5.28-6-9.8V7.3l6-3.04z"
                                />
                                <path
                                    d="M12 7a2 2 0 0 0-2 2v2a2 2 0 0 0 1 1.72V15h2v-2.28A2 2 0 0 0 14 11V9a2 2 0 0 0-2-2z"
                                />
                            </svg>
                            <span
                                class="text-xl font-bold bg-gradient-to-r from-blue-400 to-cyan-300 text-transparent bg-clip-text"
                            >
                                Prober
                            </span>
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- CVE Input Section -->
            <div
                class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 mb-8"
            >
                <div class="mb-6">
                    <label
                        for="cve_id"
                        class="block text-sm font-medium text-gray-300 mb-2"
                        >Enter CVE ID</label
                    >
                    <input
                        type="text"
                        id="cve_id"
                        placeholder="e.g. CVE-2021-21421"
                        class="w-full px-4 py-2 bg-slate-900/50 border border-slate-700 rounded-md text-gray-300 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                </div>

                <button
                    onclick="fixExtractor()"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors"
                >
                    Get Patching Details
                </button>

                <button
                    onclick="fetchCveData()"
                    class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors mr-4"
                >
                    Get CVE Details
                </button>

            <!-- Error message display -->
                <div id="error-message" class="text-red-600 mt-4 hidden"></div>
            </div>


            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden">
                <div
                    class="w-12 h-12 border-4 border-blue-400 border-t-transparent rounded-full animate-spin mx-auto"
                ></div>
            </div>

            <!-- Results Container -->
            <div id="result" class="space-y-6"></div>

            <!-- Git Analysis Section http://prober.csirogoogleproject.com -->
            <div
                class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 mt-8"
            >
                <div class="flex space-x-4 mb-6">
                    <button
                        onclick="analyseCommits()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md transition-colors"
                    >
                        Start Task
                    </button>
                    <button
                        onclick="terminateTask()"
                        class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-md transition-colors"
                    >
                        Terminate Task
                    </button>
                    <button
                        onclick="clearResults()"
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md transition-colors"
                    >
                        Clear Results
                    </button>
                </div>



                <div class="flex space-x-20 text-gray-300 mb-6">
                    <p id="task-id">Task ID: None</p>
                    <p id="task-status">Status: None</p>
                    <p id="task-result">Result: None</p>
                </div>


                <!-- Results Table -->
                <div class="overflow-x-auto">
                    <table id="resultsTable" class="w-full">
                        <thead class="bg-slate-700/50">
                            <tr>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600 w-28"
                                >
                                    Source
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                >
                                    Top-Ranked Commit
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                >
                                    Similarity Score: Normalised (Actual)
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                    style="width: 200px;"
                                >
                                    Affected Files
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                    style="width: 200px;"
                                >
                                    Affected Functions
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                >
                                    Hunk Headers
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                >
                                    Added Lines
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                >
                                    Removed Lines
                                </th>
                                <th
                                    class="px-4 py-2 text-left text-gray-300 border border-slate-600"
                                >
                                    Model Prediction
                                </th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-100 bg-gray-800 border-t border-gray-700">
                            <!-- Table content will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            const eventSource = new EventSource('http://localhost:5000/api/stream');
            eventSource.onmessage = function (event) {
                const data = JSON.parse(event.data);
                console.log(event.data);
                if (data.type === 'progress') {
                    // Update the progress bar
                    const progress = data.progress;
                    const message = data.message;

                    // Update the progress bar's width and message
                    document.getElementById('progress-fill').style.width =
                        progress + '%';
                    document.getElementById('message').textContent = message;
                }
            };

            eventSource.onerror = function (error) {
                console.error('Error with SSE connection:', error);
            };

            eventSource.onopen = () => {
                console.log('Connection opened');
            };

            eventSource.onerror = error => {
                console.log('Error:', error);
            };
            function fetchCveData() {
                const cveId = document.getElementById('cve_id').value.trim();

                if (!cveId) {
                    alert('Please enter a CVE ID.');
                    return;
                }
                document.getElementById('loading-spinner').style.display =
                    'block';
                document.getElementById('result').innerHTML = '';

                const url = `http://localhost:5000/api/process_cve?cve_id=${cveId}`;
                fetch(url)
                .then(response => response.json())
                .then(data => {
                    // Check if data is an array and follows the expected structure
                    if (Array.isArray(data) && data.length === 2 && data[0].error && typeof data[1] === "number") {
                        const errorMessage = `${data[0].error}, ${data[1]}`;
                        console.error(errorMessage);
                        showCVEProcessingError(errorMessage); // Display error message in UI
                    } else if (data.error) {
                        showCVEProcessingError(data.error); // Handle standard error object
                    } else {
                        console.log(data);
                        showCveData(data); // Process and display CVE data
                    }
                })
                .catch(error => {
                    console.error('Error fetching CVE data:', error);
                    showCVEProcessingError('An error occurred while fetching data.');
                })
                .finally(() => {
                    document.getElementById('loading-spinner').style.display = 'none';
                });
            }

            function fixExtractor() {
                const cveId = document.getElementById('cve_id').value.trim();

                // Validate CVE ID input
                if (!cveId) {
                    alert('Please enter a CVE ID.');
                    return;
                }

                const errorDiv = document.getElementById('error-message');
                errorDiv.classList.add('hidden'); // Make the error message visible

                // Show loading spinner
                document.getElementById('loading-spinner').style.display = 'block';
                document.getElementById('result').innerHTML = '';

                const url = `http://localhost:5000/api/cve_fix_extractor?cve_id=${cveId}`;

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        // Check for structured error response
                        if (Array.isArray(data) && data.length === 2 && data[0].error && typeof data[1] === "number") {
                            const errorMessage = `${data[0].error}, ${data[1]}`;
                            console.error(errorMessage);
                            showCVEProcessingError(errorMessage);
                            return;
                        }

                        // Handle standard error or successful data
                        if (data.error) {
                            showCVEProcessingError(data.error);
                        } else {
                            console.log(data);
                            showFixMinerData(data);
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching CVE data:', error);
                        showCVEProcessingError('An error occurred while fetching data.');
                    })
                    .finally(() => {
                        // Hide loading spinner
                        document.getElementById('loading-spinner').style.display = 'none';
                    });
            }

            async function terminateTask() {
                const taskId = document
                    .getElementById('task-id')
                    .innerText.split(' ')[2];
                if (taskId) {
                    await fetch(
                        `http://localhost:5000/api/terminate_task/${taskId}`,
                        { method: 'POST' }
                    );
                    document.getElementById('task-status').innerText =
                        'Status: Terminated';
                }
            }

            function addTableHeader() {
                const table = document.querySelector('#resultsTable');
                if (!table.querySelector('thead')) {
                    const thead = document.createElement('thead');
                    thead.innerHTML = `
                <tr>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Source</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Top-Ranked Commit</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Similarity Score: Normalised (Actual)</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Affected Files</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Affected Functions</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Hunk Headers</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Added Lines</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Removed Lines</th>
                    <th class="px-4 py-2 text-left text-gray-300 border border-slate-600">Model Prediction</th>
                </tr>
            `;
                    table.prepend(thead);
                }
            }

            function showCveData(data) {
                const resultContainer = document.getElementById('result');
                resultContainer.innerHTML = `
            <div class="space-y-6">
                <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-2">CVE Description</h2>
                    <p class="text-gray-400">${data.cve_id}</p>
                </div>

                <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-2">Git Repository</h2>
                    <a href="${
                        data.repo_url
                    }" target="_blank" class="text-blue-400 hover:text-blue-300">${
                    data.repo_url
                }</a>
                </div>

                <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-2">Total Commits</h2>
                    <p class="text-gray-400">${data.total_commits}</p>
                </div>

                <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-2">Parsed Result</h2>
                    <pre class="text-gray-400 overflow-x-auto">${JSON.stringify(
                        data.parsed_result,
                        null,
                        2
                    )}</pre>
                </div>

                <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-300 mb-4">Version Selection</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-300 mb-2">Version A:</label>
                            <select id="closest_affected_tag" onchange="updateCommitCount()"
                                    class="w-full bg-slate-900/50 border border-slate-700 rounded-md text-gray-300 px-4 py-2">
                                <option value="${data.closest_av}">${
                    data.closest_av
                }</option>
                                ${
                                    data.ver_tags
                                        ? data.ver_tags
                                              .map(tag =>
                                                  tag !== data.closest_av
                                                      ? `<option value="${tag}">${tag}</option>`
                                                      : ''
                                              )
                                              .join('')
                                        : ''
                                }
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Version B:</label>
                            <select id="closest_fixed_tag" onchange="updateCommitCount()"
                                    class="w-full bg-slate-900/50 border border-slate-700 rounded-md text-gray-300 px-4 py-2">
                                <option value="${data.closest_fv}">${
                    data.closest_fv
                }</option>
                                ${
                                    data.ver_tags
                                        ? data.ver_tags
                                              .map(tag =>
                                                  tag !== data.closest_fv
                                                      ? `<option value="${tag}">${tag}</option>`
                                                      : ''
                                              )
                                              .join('')
                                        : ''
                                }
                            </select>
                        </div>
                        <div id="commit-count" class="mt-4">
                            <span class="text-gray-300">Commits Between Versions:</span>
                            <span id="commit-count-value" class="text-gray-400">${
                                data.commits_between_versions
                            }</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
            }


<!--            function showFixMinerData(data) {-->
<!--                const resultContainer = document.getElementById('result');-->
<!--                const cve_id = JSON.parse(data.cve_id);-->
<!--                const analysed_pages = JSON.parse(data.analysed_pages);-->
<!--                const parsedFixCommits = JSON.parse(data.fix_commits);-->

<!--                resultContainer.innerHTML = `-->
<!--                    <div class="space-y-6">-->

<!--                        &lt;!&ndash; Vulnerability Details &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Vulnerability Details</h2>-->
<!--                            <p class="text-gray-400">${parsedFixCommits.vulnerability_details}</p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Analysed Pages &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Commit</h2>-->
<!--                            <p class="text-gray-400">Commit Hash:-->
<!--                                <a href=${analysed_pages}-->
<!--                                   target="_blank"-->
<!--                                   class="text-blue-400 hover:text-blue-300">-->
<!--                                    ${analysed_pages}-->
<!--                                </a>-->
<!--                            </p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Fix Commit &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Commit</h2>-->
<!--                            <p class="text-gray-400">Commit Hash:-->
<!--                                <a href="https://github.com/commit/${parsedFixCommits.fix_commit}"-->
<!--                                   target="_blank"-->
<!--                                   class="text-blue-400 hover:text-blue-300">-->
<!--                                    ${parsedFixCommits.fix_commit}-->
<!--                                </a>-->
<!--                            </p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Fixed Versions &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fixed Versions</h2>-->
<!--                            <p class="text-gray-400">${parsedFixCommits.fixed_versions}</p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Fix Exists &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Exists</h2>-->
<!--                            <p class="text-gray-400">${parsedFixCommits.fix_exists}</p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Vulnerable Artifacts &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Vulnerable Artifacts</h2>-->
<!--                            <div>-->
<!--                                <h3 class="text-gray-300 mb-2">Source Files:</h3>-->
<!--                                <ul class="text-gray-400">-->
<!--                                    ${parsedFixCommits.vulnerable_artifacts.source_files.map(file => `<li>${file}</li>`).join('')}-->
<!--                                </ul>-->
<!--                            </div>-->
<!--                            <div>-->
<!--                                <h3 class="text-gray-300 mb-2">Functions:</h3>-->
<!--                                <ul class="text-gray-400">-->
<!--                                    ${parsedFixCommits.vulnerable_artifacts.functions.map(func => `<li>${func}</li>`).join('')}-->
<!--                                </ul>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                `;-->
<!--            }-->


<!--            function showFixMinerData(data) {-->
<!--                const resultContainer = document.getElementById('result');-->
<!--                const parsedFixCommits = JSON.parse(data.fix_commits); // Parse the fix_commits string to an object-->

<!--                resultContainer.innerHTML = `-->
<!--                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">-->

<!--                        &lt;!&ndash; Vulnerability Details &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 col-span-2">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Vulnerability Details</h2>-->
<!--                            <p class="text-gray-400">${parsedFixCommits.cve_id} - ${parsedFixCommits.vulnerability_details}</p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Analysed Pages &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Analysed Pages</h2>-->
<!--                            <p class="text-gray-400">Commit Hash:-->
<!--                                <a href="analysed_pages}"-->
<!--                                   target="_blank"-->
<!--                                   class="text-blue-400 hover:text-blue-300">-->
<!--                                    ${analysed_pages}-->
<!--                                </a>-->
<!--                            </p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Fix Commit &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Commit</h2>-->
<!--                            <p class="text-gray-400">Commit Hash:-->
<!--                                <a href="https://github.com/commit/${parsedFixCommits.fix_commit}"-->
<!--                                   target="_blank"-->
<!--                                   class="text-blue-400 hover:text-blue-300">-->
<!--                                    ${parsedFixCommits.fix_commit}-->
<!--                                </a>-->
<!--                            </p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Fixed Versions &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fixed Versions</h2>-->
<!--                            <p class="text-gray-400">${parsedFixCommits.fixed_versions}</p>-->
<!--                        </div>-->

<!--                        &lt;!&ndash; Fix Exists &ndash;&gt;-->
<!--                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">-->
<!--                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Exists</h2>-->
<!--                            <p class="text-gray-400">${parsedFixCommits.fix_exists}</p>-->
<!--                        </div>-->





            function showFixMinerData(data) {
                const resultContainer = document.getElementById('result');

                // Ensure data is valid
                if (!data || typeof data !== "object") {
                    resultContainer.innerHTML = "<p class='text-red-400'>Invalid data received from API.</p>";
                    return;
                }

                // Extract CVE ID
                const cve_id = data.cve_id || "Unknown CVE";

                // Extract CVE Desc
                const cve_desc = data.cve_desc || "Unknown CVE Desc";

                // Extract Repo
                const repo = data.git_repo_url || "Unknown Repo";


                // Parse analysed pages (ensure it's an array)
                const analysed_pages = Array.isArray(data.analysed_pages) ? data.analysed_pages : [];

                // Parse fix_commits (ensure it's a valid JSON string)
                let parsedFixCommits = {};
                if (data.fix_commits) {
                    try {
                        parsedFixCommits = JSON.parse(data.fix_commits);
                    } catch (error) {
                        console.error("Error parsing fix_commits:", error);
                    }
                }

                // Extract fix commit details safely
                const cve_detail = parsedFixCommits.vulnerability_details || "N/A";
                // const fix_commit = parsedFixCommits.fix_commit || "N/A";
                // Ensure fix_commits is properly displayed as text
                const fix_commit_text = typeof parsedFixCommits.fix_commit=== "string" ? parsedFixCommits.fix_commit : JSON.stringify(parsedFixCommits.fix_commit, null, 2);

                const fixed_versions = parsedFixCommits.fixed_versions || "N/A";
                const fix_exists = parsedFixCommits.fix_exists || "N/A";

                // Extract vulnerable artifacts safely
                const vulnerable_artifacts = parsedFixCommits.vulnerable_artifacts || {};
                const source_files = Array.isArray(vulnerable_artifacts.source_files) ? vulnerable_artifacts.source_files : [];
                const functions = Array.isArray(vulnerable_artifacts.functions) ? vulnerable_artifacts.functions : [];

                // Display the results in HTML
                resultContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                        <!-- Combined and Enhanced CVE Details -->
                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 col-span-2">
                            <h2 class="text-lg font-semibold text-gray-300 mb-4">Vulnerability Details</h2>

                            <!-- Git-based Vulnerability -->
                            <div class="text-gray-400 mb-4">
                                <strong class="text-blue-400">Automated Vulnerability Description Extraction:</strong>
                                <span class="text-gray-200">${cve_detail}</span>
                            </div>

                            <!-- OSV-based CVE Description -->
                            <div class="text-gray-400 mb-4">
                                <strong class="text-blue-400">OSV-based CVE Description:</strong>
                                <span class="text-gray-200">${cve_id} - ${cve_desc}</span>
                            </div>

                            <!-- Git Repository URL -->
                            <div class="text-gray-400">
                                <strong class="text-blue-400">Git Repo:</strong>
                                <a href="${repo}" target="_blank" class="text-blue-400 hover:text-blue-300 underline">${repo}</a>
                            </div>
                        </div>

                        <!-- Analysed Pages -->
                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 col-span-2">
                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Analysed Pages</h2>
                            <ul class="text-gray-400 list-disc pl-4">
                                ${analysed_pages.length > 0
                                    ? analysed_pages.map(page => `<li><a href="${page}" target="_blank" class="text-blue-400 hover:text-blue-300">${page}</a></li>`).join('')
                                    : "<li>No pages available</li>"
                                }
                            </ul>
                        </div>

                        <!-- Fix Commit  -->
                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 col-span-2">
                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Commit Details</h2>
                            <pre class="text-gray-400 whitespace-pre-wrap">${fix_commit_text}</pre>
                        </div>

                        <!-- Fixed Versions & Fix Exists -->
                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6">
                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Fix Information</h2>
                            <p class="text-gray-400"><strong>Fixed Versions:</strong> ${fixed_versions}</p>
                            <p class="text-gray-400"><strong>Fix Exists:</strong> ${fix_exists}</p>
                        </div>


                        <!-- Vulnerable Artifacts -->
                        <div class="bg-slate-800/30 border border-slate-700/50 rounded-lg p-6 col-span-2">
                            <h2 class="text-lg font-semibold text-gray-300 mb-2">Vulnerable Artifacts</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h3 class="text-gray-300 mb-2">Source Files:</h3>
                                    <ul class="text-gray-400 list-disc pl-4">
                                        ${source_files.length > 0
                                            ? source_files.map(file => `<li>${file}</li>`).join('')
                                            : "<li>No source files available</li>"
                                        }
                                    </ul>
                                </div>
                                <div>
                                    <h3 class="text-gray-300 mb-2">Functions:</h3>
                                    <ul class="text-gray-400 list-disc pl-4">
                                        ${functions.length > 0
                                            ? functions.map(func => `<li>${func}</li>`).join('')
                                            : "<li>No functions available</li>"
                                        }
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }


            function clearResults() {
                document.getElementById('task-id').innerText = 'Task ID: None';
                document.getElementById('task-status').innerText =
                    'Status: None';
                document.getElementById('task-result').innerText =
                    'Result: None';
                const table = document.getElementById('resultsTable');
                table.innerHTML = '';
                addTableHeader();
            }

            function analyseCommits() {
                const cveId = document.getElementById('cve_id').value.trim();
                if (!cveId) {
                    alert('Please enter a CVE ID and fetch CVE details first.');
                    return;
                }

                console.log('Starting analysis for CVE ID:', cveId);

                fetch('http://localhost:5000/api/start_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cve_id: cveId,
                        repo_path: 'path_to_repo',
                        cve_desc: 'CVE description',
                    }),
                })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Start task response:', data);
                        if (data.task_id) {
                            document.getElementById(
                                'task-id'
                            ).innerText = `Task ID: ${data.task_id}`;
                            pollTaskStatus(data.task_id);
                        } else {
                            showError('Task failed to start.');
                        }
                    })
                    .catch(error => {
                        console.error('Error starting analysis task:', error);
                        showError('Error starting analysis task.');
                    });
            }

            function updateCommitCount() {
                const affectedTag = document.getElementById(
                    'closest_affected_tag'
                ).value;
                const fixedTag =
                    document.getElementById('closest_fixed_tag').value;
                const cveId = document.getElementById('cve_id').value.trim();
                fetchCommitCount(cveId, affectedTag, fixedTag);
            }

            function fetchCommitCount(cve_id, affectedTag, fixedTag) {
                const url = `http://localhost:5000/api/get_commit_count?affected_tag=${affectedTag}&fixed_tag=${fixedTag}`;

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ cve_id: cve_id }),
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error:', data.error);
                        } else {
                            console.log(
                                'Commit Count:',
                                data.commits_between_versions
                            );
                            console.log('Hashes:', data.g_hashes);
                            const commitCountElement =
                                document.getElementById('commit-count-value');
                            commitCountElement.textContent =
                                data.commits_between_versions ||
                                'No data available';
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching commit count:', error);
                    });
            }

            function pollTaskStatus(taskId) {
                console.log('Polling for task status with task ID:', taskId);
                const interval = setInterval(() => {
                    fetch(`http://localhost:5000/api/task_status/${taskId}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Task status response:', data);

                            if (data.state === 'PROGRESS') {
                                const percentage = (
                                    (data.current / data.total) *
                                    100
                                ).toFixed(0);
                                document.getElementById(
                                    'task-status'
                                ).innerText = `Status: ${data.state} (${percentage}%)`;
                            } else if (data.state === 'SUCCESS') {
                                document.getElementById(
                                    'task-result'
                                ).innerText = `Status: ${data.state}`;
                                clearResults();
                                console.log('Data received:', data.result.consolidated_ranks);
                                populateTable(
                                    'Gemini',
                                    data.result.consolidated_ranks
                                );
                                document.getElementById(
                                    'task-status'
                                ).innerText = `Status: Completed (100%)`;
                                clearInterval(interval);
                            } else if (data.state === 'FAILURE') {
                                console.error('Task failed.');
                                showError('Analysis failed.');
                                clearInterval(interval);
                            } else if (data.state === 'REVOKED') {
                                clearInterval(interval);
                            } else if (data.state === 'PENDING') {
                                document.getElementById(
                                    'task-status'
                                ).innerText = `Status: ${data.state}`;
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching task status:', error);
                            showError('Error while polling task status.');
                            clearInterval(interval);
                        });
                }, 2000);
            }

            function populateTable(source, rankedData) {
                const table = document.getElementById('resultsTable');

                rankedData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-t border-slate-700';

                    // Source column
                    const sourceCell = document.createElement('td');
                    sourceCell.className = 'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    sourceCell.textContent = item.source;
                    row.appendChild(sourceCell);

                    // Commit URL column
                    const commitUrlCell = document.createElement('td');
                    commitUrlCell.className =
                        'px-4 py-2 border border-slate-600';
                    const link = document.createElement('a');
                    const urlParts = item.commit_url.split('/');
                    const commitHash = urlParts[urlParts.length - 1].slice(
                        0,
                        7
                    );
                    link.href = item.commit_url;
                    link.textContent = commitHash;
                    link.className = 'text-blue-400 hover:text-blue-300';
                    link.target = '_blank';
                    commitUrlCell.appendChild(link);
                    row.appendChild(commitUrlCell);

                    // Similarity Score column
                    const similarityCell = document.createElement('td');
                    similarityCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    similarityCell.textContent = `${item.normalised_score.toFixed(
                        4
                    )} (${item.similarity_score.toFixed(4)})`;
                    row.appendChild(similarityCell);

                    // Affected Files column
                    const affectedFilesCell = document.createElement('td');
                    affectedFilesCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    affectedFilesCell.innerHTML = item.affected_files.length
                        ? item.affected_files.join('<br>')
                        : 'None';
                    row.appendChild(affectedFilesCell);

                    // Affected Functions column
                    const affectedFunctionsCell = document.createElement('td');
                    affectedFunctionsCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    const functionsContent =
                        Array.isArray(item.affected_functions) &&
                        item.affected_functions.every(func => func === 'N/A')
                            ? 'None'
                            : Array.isArray(item.affected_functions)
                            ? item.affected_functions
                                  .map(func => func || 'N/A')
                                  .join('<br>')
                            : 'None';
                    affectedFunctionsCell.innerHTML = functionsContent;
                    row.appendChild(affectedFunctionsCell);

                    // Hunk Headers column
                    const hunkHeadersCell = document.createElement('td');
                    hunkHeadersCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    hunkHeadersCell.textContent = item.hunk_headers;
                    row.appendChild(hunkHeadersCell);

                    // Added Lines column
                    const addedLinesCell = document.createElement('td');
                    addedLinesCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    addedLinesCell.textContent = item.added_lines;
                    row.appendChild(addedLinesCell);

                    // Removed Lines column
                    const removedLinesCell = document.createElement('td');
                    removedLinesCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    removedLinesCell.textContent = item.removed_lines;
                    row.appendChild(removedLinesCell);

                    // Model Prediction column
                    const modelPredictionCell = document.createElement('td');
                    modelPredictionCell.className =
                        'px-4 py-2 border border-slate-600 text-gray-100 bg-gray-800';
                    modelPredictionCell.textContent = item.model_prediction;
                    row.appendChild(modelPredictionCell);

                    table.appendChild(row);
                });
            }

            function showError(message) {
                 const resultContainer = document.getElementById('task-status');
                resultContainer.innerText = `Error: ${message}`;
            }

            function showCVEProcessingError(message) {
                const errorDiv = document.getElementById('error-message');
                errorDiv.textContent = message; // Set error message text
                errorDiv.classList.remove('hidden'); // Make the error message visible
            }
        </script>
    </body>
</html>